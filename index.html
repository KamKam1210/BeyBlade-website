<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ†æ—‹é™€èºXä¸–ä»£è¨ˆåˆ†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #ff6b35 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b35, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #e0e0e0;
        }

        .language-switch {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-switch:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .player-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255,107,53,0.3);
        }

        .player-card.selected {
            border-color: #ff6b35;
            background: rgba(255,107,53,0.2);
            transform: scale(1.05);
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #ffd700);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b35, #ff8c42);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,107,53,0.3);
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.4);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2a5298, #1e3c72);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(42,82,152,0.4);
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-zone {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .player-zone.winner {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            animation: winnerGlow 1s ease infinite alternate;
        }

        @keyframes winnerGlow {
            from { box-shadow: 0 0 20px rgba(255,215,0,0.5); }
            to { box-shadow: 0 0 30px rgba(255,215,0,0.8); }
        }

        .player-score {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .score-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .score-btn {
            padding: 12px 8px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .score-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .score-btn:active::before {
            width: 100px;
            height: 100px;
        }

        .xf-btn {
            background: linear-gradient(45deg, #ff6b35, #ff8c42);
            color: white;
        }

        .of-btn {
            background: linear-gradient(45deg, #2a5298, #4169e1);
            color: white;
        }

        .bf-btn {
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
            color: white;
        }

        .sf-btn {
            background: linear-gradient(45deg, #28a745, #4caf50);
            color: white;
        }

        .game-log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9em;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .rules-section {
            margin: 20px 0;
        }

        .rules-section h3 {
            color: #ff6b35;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .rules-section ul {
            list-style: none;
            padding-left: 0;
        }

        .rules-section li {
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #ff6b35;
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .score-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,107,53,0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            scale: 0.5;
            transition: all 0.3s ease;
        }

        .score-popup.show {
            opacity: 1;
            scale: 1;
        }

        @media (max-width: 768px) {
            .logo { font-size: 2em; }
            .game-board { grid-template-columns: 1fr; }
            .score-buttons { grid-template-columns: 1fr; }
            .player-selection { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 480px) {
            .container { padding: 10px; }
            .card { padding: 20px; }
            .logo { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="container">
        <div class="header">
            <button class="language-switch" onclick="toggleLanguage()" id="langBtn">English</button>
            <h1 class="logo" data-zh="çˆ†æ—‹é™€èºXä¸–ä»£" data-en="Beyblade X Championship">çˆ†æ—‹é™€èºXä¸–ä»£</h1>
            <p class="subtitle" data-zh="å°ˆæ¥­è¨ˆåˆ†ç³»çµ±" data-en="Professional Scoring System">å°ˆæ¥­è¨ˆåˆ†ç³»çµ±</p>
        </div>

        <!-- ä¸»é¸å–®é é¢ -->
        <div class="page active" id="menuPage">
            <div class="card">
                <h2 data-zh="æ­¡è¿ä¾†åˆ°ç«¶æŠ€å ´ï¼" data-en="Welcome to the Arena!">æ­¡è¿ä¾†åˆ°ç«¶æŠ€å ´ï¼</h2>
                <div style="display: flex; flex-wrap: wrap; justify-content: center; margin: 30px 0;">
                    <button class="btn" onclick="showPage('playerSelectionPage')" data-zh="é–‹å§‹æ¯”è³½" data-en="Start Battle">é–‹å§‹æ¯”è³½</button>
                    <button class="btn btn-secondary" onclick="showPage('rulesPage')" data-zh="è¦å‰‡èªªæ˜" data-en="Rules">è¦å‰‡èªªæ˜</button>
                    <button class="btn btn-secondary" onclick="showPage('statsPage')" data-zh="æ¯”è³½çµ±è¨ˆ" data-en="Statistics">æ¯”è³½çµ±è¨ˆ</button>
                </div>
            </div>
        </div>

        <!-- é¸æ‰‹é¸æ“‡é é¢ -->
        <div class="page" id="playerSelectionPage">
            <div class="card">
                <h2 data-zh="é¸æ“‡åƒè³½é¸æ‰‹ (2-4äºº)" data-en="Select Players (2-4)">é¸æ“‡åƒè³½é¸æ‰‹ (2-4äºº)</h2>
                <div class="player-selection">
                    <div class="player-card" onclick="togglePlayer('Peter')">
                        <div class="player-avatar">P</div>
                        <h3>Peter</h3>
                    </div>
                    <div class="player-card" onclick="togglePlayer('Michael')">
                        <div class="player-avatar">M</div>
                        <h3>Michael</h3>
                    </div>
                    <div class="player-card" onclick="togglePlayer('Sam')">
                        <div class="player-avatar">S</div>
                        <h3>Sam</h3>
                    </div>
                    <div class="player-card" onclick="togglePlayer('Mandy')">
                        <div class="player-avatar">M</div>
                        <h3>Mandy</h3>
                    </div>
                    <div class="player-card" onclick="togglePlayer('Amy')">
                        <div class="player-avatar">A</div>
                        <h3>Amy</h3>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="showPage('menuPage')" data-zh="è¿”å›" data-en="Back">è¿”å›</button>
                    <button class="btn" onclick="startGame()" id="startGameBtn" style="opacity: 0.5;" disabled data-zh="é–‹å§‹éŠæˆ²" data-en="Start Game">é–‹å§‹éŠæˆ²</button>
                </div>
            </div>
        </div>

        <!-- éŠæˆ²é é¢ -->
        <div class="page" id="gamePage">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 data-zh="ç«¶æŠ€å ´å°æˆ°" data-en="Arena Battle">ç«¶æŠ€å ´å°æˆ°</h2>
                    <div class="timer" id="timer">00:00</div>
                    <div>
                        <button class="btn btn-secondary" onclick="resetRound()" data-zh="é‡è³½" data-en="Reset Round">é‡è³½</button>
                        <button class="btn btn-secondary" onclick="pauseTimer()" id="pauseBtn" data-zh="æš«åœ" data-en="Pause">æš«åœ</button>
                    </div>
                </div>
                
                <div class="game-board" id="gameBoard">
                    <!-- å‹•æ…‹ç”Ÿæˆé¸æ‰‹å€åŸŸ -->
                </div>

                <div class="game-log">
                    <h4 data-zh="æ¯”è³½è¨˜éŒ„" data-en="Battle Log">æ¯”è³½è¨˜éŒ„</h4>
                    <div id="gameLog"></div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="endGame()" data-zh="çµæŸæ¯”è³½" data-en="End Game">çµæŸæ¯”è³½</button>
                </div>
            </div>
        </div>

        <!-- çµæœé é¢ -->
        <div class="page" id="resultPage">
            <div class="card">
                <h2 data-zh="æ¯”è³½çµæœ" data-en="Battle Results">æ¯”è³½çµæœ</h2>
                <div id="winnerDisplay" style="text-align: center; margin: 30px 0;">
                    <h1 style="font-size: 3em; color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ğŸ†</h1>
                    <h2 id="winnerName" style="color: #ffd700;">Winner</h2>
                </div>
                
                <div class="stats-grid" id="finalStats">
                    <!-- å‹•æ…‹ç”Ÿæˆæœ€çµ‚çµ±è¨ˆ -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showPage('playerSelectionPage')" data-zh="å†ä¾†ä¸€å±€" data-en="Play Again">å†ä¾†ä¸€å±€</button>
                    <button class="btn btn-secondary" onclick="showPage('menuPage')" data-zh="å›åˆ°ä¸»é¸å–®" data-en="Main Menu">å›åˆ°ä¸»é¸å–®</button>
                </div>
            </div>
        </div>

        <!-- è¦å‰‡é é¢ -->
        <div class="page" id="rulesPage">
            <div class="card">
                <h2 data-zh="æ–‡è—å¾©èˆˆçˆ†æ—‹é™€èº 2025å®˜æ–¹è¦å‰‡" data-en="Renaissance Beyblade 2025 Official Rules">æ–‡è—å¾©èˆˆçˆ†æ—‹é™€èº 2025å®˜æ–¹è¦å‰‡</h2>
                
                <div class="rules-section">
                    <h3 data-zh="è¨ˆåˆ†æ–¹å¼" data-en="Scoring System">è¨ˆåˆ†æ–¹å¼</h3>
                    <ul>
                        <li><strong>Xtreme Finish (XF)</strong> - <span data-zh="3åˆ†ï¼šå°æ‰‹é€²å…¥Xtreme Zoneä¸”æœªè¿”å›" data-en="3 points: Opponent enters Xtreme Zone and doesn't return">3åˆ†ï¼šå°æ‰‹é€²å…¥Xtreme Zoneä¸”æœªè¿”å›</span></li>
                        <li><strong>Over Finish (OF)</strong> - <span data-zh="2åˆ†ï¼šå°æ‰‹é€²å…¥Over Zoneä¸”æœªè¿”å›" data-en="2 points: Opponent enters Over Zone and doesn't return">2åˆ†ï¼šå°æ‰‹é€²å…¥Over Zoneä¸”æœªè¿”å›</span></li>
                        <li><strong>Burst Finish (BF)</strong> - <span data-zh="2åˆ†ï¼šå°æ‰‹é™€èºéƒ¨ä»¶è„«è½åˆ†é›¢" data-en="2 points: Opponent's Beyblade bursts apart">2åˆ†ï¼šå°æ‰‹é™€èºéƒ¨ä»¶è„«è½åˆ†é›¢</span></li>
                        <li><strong>Spin Finish (SF)</strong> - <span data-zh="1åˆ†ï¼šå°æ‰‹åœæ­¢æ—‹è½‰" data-en="1 point: Opponent stops spinning">1åˆ†ï¼šå°æ‰‹åœæ­¢æ—‹è½‰</span></li>
                    </ul>
                </div>

                <div class="rules-section">
                    <h3 data-zh="å‹åˆ©æ¢ä»¶" data-en="Victory Conditions">å‹åˆ©æ¢ä»¶</h3>
                    <ul>
                        <li data-zh="ç‡å…ˆé”åˆ°4åˆ†çš„é¸æ‰‹ç²å‹" data-en="First player to reach 4 points wins">ç‡å…ˆé”åˆ°4åˆ†çš„é¸æ‰‹ç²å‹</li>
                        <li data-zh="æœ€å¤šæ”¯æ´4äººåŒæ™‚å°æˆ°" data-en="Maximum 4 players can battle simultaneously">æœ€å¤šæ”¯æ´4äººåŒæ™‚å°æˆ°</li>
                    </ul>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="showPage('menuPage')" data-zh="è¿”å›ä¸»é¸å–®" data-en="Back to Menu">è¿”å›ä¸»é¸å–®</button>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆé é¢ -->
        <div class="page" id="statsPage">
            <div class="card">
                <h2 data-zh="æ¯”è³½çµ±è¨ˆ" data-en="Battle Statistics">æ¯”è³½çµ±è¨ˆ</h2>
                
                <div class="stats-grid" id="playerStats">
                    <!-- å‹•æ…‹ç”Ÿæˆçµ±è¨ˆæ•¸æ“š -->
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="clearStats()" data-zh="æ¸…é™¤çµ±è¨ˆ" data-en="Clear Stats">æ¸…é™¤çµ±è¨ˆ</button>
                    <button class="btn btn-secondary" onclick="showPage('menuPage')" data-zh="è¿”å›ä¸»é¸å–®" data-en="Back to Menu">è¿”å›ä¸»é¸å–®</button>
                </div>
            </div>
        </div>
    </div>

    <div class="score-popup" id="scorePopup"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentLanguage = 'zh';
        let selectedPlayers = [];
        let gameData = {
            players: [],
            scores: {},
            gameLog: [],
            startTime: null,
            timer: null,
            isPaused: false,
            elapsedTime: 0
        };
        let playerStats = JSON.parse(localStorage.getItem('beybladeStats')) || {};

        // åˆå§‹åŒ–ç²’å­æ•ˆæœ
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // éŸ³æ•ˆå‡½æ•¸
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let frequency;
            
            switch(type) {
                case 'score': frequency = 800; break;
                case 'win': frequency = 1000; break;
                case 'click': frequency = 400; break;
                default: frequency = 600;
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // èªè¨€åˆ‡æ›
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            updateLanguage();
        }

        function updateLanguage() {
            const elements = document.querySelectorAll('[data-zh][data-en]');
            elements.forEach(el => {
                el.textContent = el.getAttribute(`data-${currentLanguage}`);
            });
            
            document.getElementById('langBtn').textContent = currentLanguage === 'zh' ? 'English' : 'ä¸­æ–‡';
        }

        // é é¢ç®¡ç†
        function showPage(pageId) {
            playSound('click');
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'statsPage') {
                loadPlayerStats();
            }
        }

        // é¸æ‰‹é¸æ“‡
        function togglePlayer(playerName) {
            playSound('click');
            const playerCard = event.currentTarget;
            
            if (selectedPlayers.includes(playerName)) {
                selectedPlayers = selectedPlayers.filter(p => p !== playerName);
                playerCard.classList.remove('selected');
            } else if (selectedPlayers.length < 4) {
                selectedPlayers.push(playerName);
                playerCard.classList.add('selected');
            }
            
            updateStartButton();
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startGameBtn');
            if (selectedPlayers.length >= 2) {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
            } else {
                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
            }
        }

        // éŠæˆ²é–‹å§‹
        function startGame() {
            if (selectedPlayers.length < 2) return;
            
            playSound('click');
            gameData = {
                players: [...selectedPlayers],
                scores: {},
                gameLog: [],
                startTime: Date.now(),
                timer: null,
                isPaused: false,
                elapsedTime: 0
            };
            
            // åˆå§‹åŒ–åˆ†æ•¸
            selectedPlayers.forEach(player => {
                gameData.scores[player] = 0;
                if (!playerStats[player]) {
                    playerStats[player] = { wins: 0, totalGames: 0, totalScore: 0 };
                }
            });
            
            createGameBoard();
            startTimer();
            showPage('gamePage');
        }

        // å‰µå»ºéŠæˆ²ç‰ˆé¢
        function createGameBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            
            gameData.players.forEach(player => {
                const playerZone = document.createElement('div');
                playerZone.className = 'player-zone';
                playerZone.innerHTML = `
                    <div class="player-avatar">${player[0]}</div>
                    <h3>${player}</h3>
                    <div class="player-score">${gameData.scores[player]}</div>
                    <div class="score-buttons">
                        <button class="score-btn xf-btn" onclick="addScore('${player}', 3, 'XF')">
                            XF<br>+3
                        </button>
                        <button class="score-btn of-btn" onclick="addScore('${player}', 2, 'OF')">
                            OF<br>+2
                        </button>
                        <button class="score-btn bf-btn" onclick="addScore('${player}', 2, 'BF')">
                            BF<br>+2
                        </button>
                        <button class="score-btn sf-btn" onclick="addScore('${player}', 1, 'SF')">
                            SF<br>+1
                        </button>
                    </div>
                `;
                gameBoard.appendChild(playerZone);
            });
        }

        // è¨ˆåˆ†åŠŸèƒ½
        function addScore(player, points, type) {
            playSound('score');
            gameData.scores[player] += points;
            
            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            updateScoreDisplay();
            
            // è¨˜éŒ„åˆ°éŠæˆ²æ—¥èªŒ
            const logEntry = `${player} ${type} +${points}åˆ†`;
            gameData.gameLog.unshift(logEntry);
            updateGameLog();
            
            // é¡¯ç¤ºå¾—åˆ†å‹•ç•«
            showScorePopup(`${player} ${type} +${points}`);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰äººç²å‹
            if (gameData.scores[player] >= 4) {
                setTimeout(() => endGameWithWinner(player), 1000);
            }
        }

        function updateScoreDisplay() {
            gameData.players.forEach(player => {
                const scoreElement = document.querySelector(`[data-player="${player}"] .player-score`) || 
                                   document.querySelector(`.player-zone:nth-child(${gameData.players.indexOf(player) + 1}) .player-score`);
                if (scoreElement) {
                    scoreElement.textContent = gameData.scores[player];
                }
            });
        }

        function updateGameLog() {
            const gameLog = document.getElementById('gameLog');
            gameLog.innerHTML = gameData.gameLog.slice(0, 10).map(entry => 
                `<div class="log-entry">${entry}</div>`
            ).join('');
        }

        function showScorePopup(text) {
            const popup = document.getElementById('scorePopup');
            popup.textContent = text;
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 1500);
        }

        // è¨ˆæ™‚å™¨åŠŸèƒ½
        function startTimer() {
            gameData.timer = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!gameData.isPaused) {
                gameData.elapsedTime = Date.now() - gameData.startTime;
            }
            
            const minutes = Math.floor(gameData.elapsedTime / 60000);
            const seconds = Math.floor((gameData.elapsedTime % 60000) / 1000);
            
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function pauseTimer() {
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (gameData.isPaused) {
                gameData.startTime = Date.now() - gameData.elapsedTime;
                startTimer();
                pauseBtn.textContent = currentLanguage === 'zh' ? 'æš«åœ' : 'Pause';
                gameData.isPaused = false;
            } else {
                clearInterval(gameData.timer);
                pauseBtn.textContent = currentLanguage === 'zh' ? 'ç¹¼çºŒ' : 'Resume';
                gameData.isPaused = true;
            }
        }

        // é‡è³½åŠŸèƒ½
        function resetRound() {
            playSound('click');
            if (confirm(currentLanguage === 'zh' ? 'ç¢ºå®šè¦é‡è³½é€™ä¸€è¼ªå—ï¼Ÿ' : 'Reset this round?')) {
                // æ¸…é™¤æœ€è¿‘çš„å¾—åˆ†è¨˜éŒ„
                if (gameData.gameLog.length > 0) {
                    gameData.gameLog = [];
                    updateGameLog();
                }
            }
        }

        // çµæŸéŠæˆ²
        function endGame() {
            if (confirm(currentLanguage === 'zh' ? 'ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ' : 'End the game?')) {
                clearInterval(gameData.timer);
                showPage('menuPage');
                resetGame();
            }
        }

        function endGameWithWinner(winner) {
            playSound('win');
            clearInterval(gameData.timer);
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            gameData.players.forEach(player => {
                playerStats[player].totalGames++;
                playerStats[player].totalScore += gameData.scores[player];
                if (player === winner) {
                    playerStats[player].wins++;
                }
            });
            
            // ä¿å­˜çµ±è¨ˆæ•¸æ“š
            localStorage.setItem('beybladeStats', JSON.stringify(playerStats));
            
            // é¡¯ç¤ºçµæœé é¢
            showGameResult(winner);
            showPage('resultPage');
        }

        function showGameResult(winner) {
            document.getElementById('winnerName').textContent = winner;
            
            const finalStats = document.getElementById('finalStats');
            finalStats.innerHTML = gameData.players.map(player => `
                <div class="stat-card ${player === winner ? 'winner' : ''}">
                    <h4>${player}</h4>
                    <div style="font-size: 2em; font-weight: bold; margin: 10px 0;">
                        ${gameData.scores[player]}
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8;">
                        ${player === winner ? (currentLanguage === 'zh' ? 'å‹åˆ©è€…ï¼' : 'Winner!') : ''}
                    </div>
                </div>
            `).join('');
        }

        function resetGame() {
            selectedPlayers = [];
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateStartButton();
        }

        // çµ±è¨ˆåŠŸèƒ½
        function loadPlayerStats() {
            const statsContainer = document.getElementById('playerStats');
            const players = ['Peter', 'Michael', 'Sam', 'Mandy', 'Amy'];
            
            statsContainer.innerHTML = players.map(player => {
                const stats = playerStats[player] || { wins: 0, totalGames: 0, totalScore: 0 };
                const winRate = stats.totalGames > 0 ? ((stats.wins / stats.totalGames) * 100).toFixed(1) : 0;
                const avgScore = stats.totalGames > 0 ? (stats.totalScore / stats.totalGames).toFixed(1) : 0;
                
                return `
                    <div class="stat-card">
                        <div class="player-avatar">${player[0]}</div>
                        <h4>${player}</h4>
                        <div><strong>${stats.wins}</strong> ${currentLanguage === 'zh' ? 'å‹' : 'Wins'}</div>
                        <div><strong>${stats.totalGames}</strong> ${currentLanguage === 'zh' ? 'å ´' : 'Games'}</div>
                        <div><strong>${winRate}%</strong> ${currentLanguage === 'zh' ? 'å‹ç‡' : 'Win Rate'}</div>
                        <div><strong>${avgScore}</strong> ${currentLanguage === 'zh' ? 'å¹³å‡åˆ†' : 'Avg Score'}</div>
                    </div>
                `;
            }).join('');
        }

        function clearStats() {
            if (confirm(currentLanguage === 'zh' ? 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå—ï¼Ÿ' : 'Clear all statistics?')) {
                playerStats = {};
                localStorage.removeItem('beybladeStats');
                loadPlayerStats();
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            updateLanguage();
            
            // ç¢ºä¿æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå®Œæ•´
            ['Peter', 'Michael', 'Sam', 'Mandy', 'Amy'].forEach(player => {
                if (!playerStats[player]) {
                    playerStats[player] = { wins: 0, totalGames: 0, totalScore: 0 };
                }
            });
        });

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('gamePage').classList.contains('active')) {
                // éŠæˆ²é é¢çš„å¿«æ·éµ
                if (e.key === ' ') {
                    e.preventDefault();
                    pauseTimer();
                }
            }
        });
    </script>
</body>
</html>
